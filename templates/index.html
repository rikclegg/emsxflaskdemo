<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Test EasyMSX+Flask</title>
    <link rel="stylesheet" href="^ url_for('static', filename='css/style.css') ^">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
  </head>
  
  <body>
    <div id="demo-header">
      <h1>EMSX API + Flask + Python Demonstration</h1>
    </div>
    <div id="emsx">
      <div id="orders" class="blotter">
        <h2 id="order-header">Orders</h2>
        <table id="order-table">
          <tr id="order-table-header">
            <th>Status</th>
            <th>Order #</th>
            <th>Side</th>
            <th>Amount</th>
            <th>Security</th>
            <th>TIF</th>
            <th>Type</th>
            <th>Limit Price</th>
            <th>Account</th>
            <th>Filled</th>
            <th>Filled(Day)</th>
            <th>Average Price</th>
            <th>Average Price(Day)</th>
            <th>Instructions</th>
          </tr>
          <tr v-for="order in orders">
            <td :id="order.EMSX_SEQUENCE+'.EMSX_STATUS'">{{ order.EMSX_STATUS}}</td>
            <td :id="order.EMSX_SEQUENCE+'.EMSX_SEQUENCE'">{{ order.EMSX_SEQUENCE}}</td>
            <td :id="order.EMSX_SEQUENCE+'.EMSX_SIDE'">{{ order.EMSX_SIDE}}</td>
            <td :id="order.EMSX_SEQUENCE+'.EMSX_AMOUNT'">{{ order.EMSX_AMOUNT}}</td>
            <td :id="order.EMSX_SEQUENCE+'.EMSX_TICKER'">{{ order.EMSX_TICKER}}</td>
            <td :id="order.EMSX_SEQUENCE+'.EMSX_TIF'">{{ order.EMSX_TIF}}</td>
            <td :id="order.EMSX_SEQUENCE+'.EMSX_ORDER_TYPE'">{{ order.EMSX_ORDER_TYPE}}</td>
            <td :id="order.EMSX_SEQUENCE+'.EMSX_LIMIT_PRICE'">{{ order.EMSX_LIMIT_PRICE}}</td>
            <td :id="order.EMSX_SEQUENCE+'.EMSX_ACCOUNT'">{{ order.EMSX_ACCOUNT}}</td>
            <td :id="order.EMSX_SEQUENCE+'.EMSX_FILLED'">{{ order.EMSX_FILLED}}</td>
            <td :id="order.EMSX_SEQUENCE+'.EMSX_DAY_FILL'">{{ order.EMSX_DAY_FILL}}</td>
            <td :id="order.EMSX_SEQUENCE+'.EMSX_AVG_PRICE'">{{ order.EMSX_AVG_PRICE}}</td>
            <td :id="order.EMSX_SEQUENCE+'.EMSX_DAY_AVG_PRICE'">{{ order.EMSX_DAY_AVG_PRICE}}</td>
            <td :id="order.EMSX_SEQUENCE+'.EMSX_NOTES'">{{ order.EMSX_NOTES}}</td>
          </tr>
        </table>
      </div>
      <div id="routes" class="blotter">
          <h2 id="route-header">Routes</h2>
          <table id="route-table">
            <tr id="route-table-header">
              <th>Status</th>
              <th>Route #</th>
              <th>Amount</th>
              <th>Security</th>
              <th>Broker</th>
              <th>TIF</th>
              <th>Type</th>
              <th>Limit Price</th>
              <th>Account</th>
              <th>Filled</th>
              <th>Filled(Day)</th>
              <th>Average Price</th>
              <th>Average Price(Day)</th>
              <th>Instructions</th>
              <th>Strategy</th>
              <th>Style</th>
              <th>Start</th>
              <th>End</th>
            </tr>
            <tr v-for="route in routes">
              <!-- Add v-bind:class="[classArray]" to each entry so that we can modify the source data (list of classes) for each entry 
              Also, if we're adding the list of fields to the Vue object below, here we will iterate that list -->
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_STATUS'">{{route.EMSX_STATUS}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_ROUTE_NO'">{{route.EMSX_ROUTE_NO}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_AMOUNT'">{{route.EMSX_AMOUNT}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_TICKER'">{{route.EMSX_TICKER}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_BROKER'">{{route.EMSX_BROKER}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_TIF'">{{route.EMSX_TIF}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_ORDER_TYPE'">{{route.EMSX_ORDER_TYPE}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_LIMIT_PRICE'">{{route.EMSX_LIMIT_PRICE}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_ACCOUNT'">{{route.EMSX_ACCOUNT}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_FILLED'">{{route.EMSX_FILLED}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_DAY_FILL'">{{route.EMSX_DAY_FILL}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_AVG_PRICE'">{{route.EMSX_AVG_PRICE}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_DAY_AVG_PRICE'">{{route.EMSX_DAY_AVG_PRICE}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_NOTES'">{{route.EMSX_NOTES}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_STRATEGY_TYPE'">{{route.EMSX_STRATEGY_TYPE}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_STRATEGY_STYLE'">{{route.EMSX_STRATEGY_STYLE}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_STRATEGY_START_TIME'">{{route.EMSX_STRATEGY_START_TIME}}</td>
              <td :id="route.EMSX_ROUTE_NO+'.EMSX_STRATEGY_END_TIME'">{{route.EMSX_STRATEGY_END_TIME}}</td>
            </tr>
          </table>
        </div>
      </div>
  </body>
  
  <script>
    console.log("p1");
    var emsx = new Vue({
      el: '#emsx',
      data: {
        //Add list of order fields and route fields. Each element has the API field name, and the display name. 
        teams: [],
        brokers: [],
        orders: {},
        routes: {},
        eventdata: {}
      }
    });
    console.log("p2");

    var socket = io.connect('http://' + document.domain + ':' + location.port+"/emsx");
    // verify our websocket connection is established
    socket.on('connect', function() {
        console.log('Websocket connected!');
        socket.emit("create","");
        socket.emit('get_teamlist');
        socket.emit('get_brokerlist');
    });
    console.log("p3");

    socket.on('teamlist', function(msg) {
      for (var i = 0; i < msg.length; i++) {
        console.log("TEAM: " + msg[i]);
        Vue.set(emsx.teams, emsx.teams.length, {"teamname":msg[i]});
      }
    });
    console.log("p4");

    socket.on('brokerlist', function(msg) {
      for (var i = 0; i < msg.length; i++) {
        console.log("BROKER: " + msg[i]);
        Vue.set(emsx.brokers, emsx.brokers.length, {"brokername":msg[i]});
      }
    });
    console.log("p5");

    socket.on('emsx-order-init', function(msg) {
      fields = {}
      for(var fc in msg) {
        field = msg[fc];
        fields[field.name] = field.new_value;
      }
      seqno = fields["EMSX_SEQUENCE"];
      if(seqno in emsx.orders) {
        order = emsx.orders[seqno];
      }
      else {
        order={};
     }
      for(var field in fields) {
        order[field]=fields[field];
      }
      emsx.$set(emsx.orders, order.EMSX_SEQUENCE, order);
    });

    socket.on('emsx-order-new', function(msg) {
      fields = {}
      for(var fc in msg) {
        field = msg[fc];
        fields[field.name] = field.new_value;
      }
      seqno = fields["EMSX_SEQUENCE"];
      if(seqno in emsx.orders) {
        order = emsx.orders[seqno];
      }
      else {
        order={};
     }
      for(var field in fields) {
        order[field]=fields[field];
      }
      emsx.$set(emsx.orders, order.EMSX_SEQUENCE, order);
    });

    socket.on('emsx-order-update', function(msg) {
      fields = {}
      for(var fc in msg) {
        field = msg[fc];
        fields[field.name] = field.new_value;
      }
      seqno = fields["EMSX_SEQUENCE"];
      if(seqno in emsx.orders) {
        order = emsx.orders[seqno];
      }
      else {
        order={};
     }
      for(var field in fields) {
        order[field]=fields[field];
      }
      emsx.$set(emsx.orders, order.EMSX_SEQUENCE, order);

      for(field in fields) {
        targetId=seqno+"."+field;
        console.log("Looking for Target: " + targetId);
        target = document.getElementById(seqno+"."+field);
        console.log("Found Target: " + target);
        if(target != null) {
          target.classList.add('highlight-updated');
          //setTimeout(function(){ target.classList.remove('highlight-updated'); }, 3000);
        }
      }
    });

    socket.on('emsx-order-delete', function(msg) {
      fields = {}
      for(var fc in msg) {
        field = msg[fc];
        fields[field.name] = field.new_value;
      }
      seqno = fields["EMSX_SEQUENCE"];
      if(seqno in emsx.orders) {
        order = emsx.orders[seqno];
      }
      else {
        order={};
     }
      for(var field in fields) {
        order[field]=fields[field];
      }
      emsx.$set(emsx.orders, order.EMSX_SEQUENCE, order);
    });

    socket.on('emsx-route-init', function(msg) {
      fields = {}
      for(var fc in msg) {
        field = msg[fc];
        fields[field.name] = field.new_value;
      }
      routeno = fields["EMSX_SEQUENCE"]+"."+fields["EMSX_ROUTE_ID"];
      fields["EMSX_ROUTE_NO"]=routeno;
      console.log("RouteNo: " + fields["EMSX_ROUTE_NO"]);

      if(routeno in emsx.routes) {
        route = emsx.routes[routeno];
      }
      else {
        route={};
     }
      for(var field in fields) {
        route[field]=fields[field];
      }
      emsx.$set(emsx.routes, routeno, route);
      console.log("New Route (INIT): " + JSON.stringify(route));
    });

    socket.on('emsx-route-new', function(msg) {
      console.log("New Route: " + JSON.stringify(msg));
      fields = {}
      for(var fc in msg) {
        field = msg[fc];
        fields[field.name] = field.new_value;
      }
      routeno = fields["EMSX_SEQUENCE"]+"."+fields["EMSX_ROUTE_ID"];
      fields["EMSX_ROUTE_NO"]=routeno;
      console.log("RouteNo: " + fields["EMSX_ROUTE_NO"]);

      if(routeno in emsx.routes) {
        route = emsx.routes[routeno];
      }
      else {
        route={};
     }
      for(var field in fields) {
        route[field]=fields[field];
      }
      emsx.$set(emsx.routes, routeno, route);
      console.log("New Route (NEW): " + JSON.stringify(route));
    });

    socket.on('emsx-route-update', function(msg) {
      console.log("Update Route: " + JSON.stringify(msg));
      fields = {}
      for(var fc in msg) {
        field = msg[fc];
        fields[field.name] = field.new_value;
      }
      routeno = fields["EMSX_SEQUENCE"]+"."+fields["EMSX_ROUTE_ID"];
      
      fields["EMSX_ROUTE_NO"]=routeno;
      console.log("RouteNo: " + fields["EMSX_ROUTE_NO"]);

      if(routeno in emsx.routes) {
        route = emsx.routes[routeno];
      }
      else {
        route={};
     }
      for(var field in fields) {
        route[field]=fields[field];
      }
      emsx.$set(emsx.routes, routeno, route);
      console.log("New Route (UPD): " + JSON.stringify(route));
    });

    socket.on('emsx-route-delete', function(msg) {
      fields = {}
      for(var fc in msg) {
        field = msg[fc];
        fields[field.name] = field.new_value;
      }
      routeno = fields["EMSX_SEQUENCE"]+"."+fields["EMSX_ROUTE_ID"];
      
      fields["EMSX_ROUTE_NO"]=routeno;

      if(routeno in emsx.routes) {
        route = emsx.routes[routeno];
      }
      else {
        route={};
     }
      for(var field in fields) {
        route[field]=fields[field];
      }
      emsx.$set(emsx.routes, routeno, route);
    });

    console.log("p6");

  </script>

</html>
